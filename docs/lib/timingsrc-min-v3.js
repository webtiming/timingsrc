var TIMINGSRC=function(t){"use strict";function e(t){for(var e="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",n=0;n<t;n++)e+=i.charAt(Math.floor(Math.random()*i.length));return e}function i(t,e){return t.size===e.size&&n(r(e),t)}function n(t,e){for(var i of e)if(!t(i))return!1;return!0}function r(t){return function(e){return t.has(e)}}function s(t,e){return new Set([...t].filter(t=>!e.has(t)))}const o=function(t,e){return 0==t.size?new Map:0==e.size?t:new Map([...t].filter((function([t,i]){return!e.has(t)})))},l=function(t,e){return[t,e]=t.size<=e.size?[t,e]:[e,t],0==t.size?new Map:new Map([...t].filter((function([t,i]){return e.has(t)})))};function a(t){return null!=t&&"function"==typeof t[Symbol.iterator]}function h(t,e={}){let{copy:i=!1,order:n=!1}=e;if(0==t.length)return[];if(1==t.length)return t[0];let r=t.reduce((t,e)=>t+e.length,0);n||t.sort((t,e)=>e.length-t.length);let s,o,l=i?[]:t.shift(),a=l.length;l.length=r;for(let e of t){o=e.length,s=a+o;for(let t=0;t<o;t++)l[a+t]=e[t];a=s}return l}function c(t,e){let i,n=Object.getOwnPropertyNames(t),r=Object.getOwnPropertyNames(e),s=n.length;if(n.length!=r.length)return!1;for(let r=0;r<s;r++)if(i=n[r],t[i]!==e[i])return!1;return!0}const u=new Promise((function(t){if("complete"===document.readyState)t();else{let e=function(){t(),document.removeEventListener("DOMContentLoaded",e,!0),window.removeEventListener("load",e,!0)};document.addEventListener("DOMContentLoaded",e,!0),window.addEventListener("load",e,!0)}}));var _=Object.freeze({__proto__:null,random_string:e,eqSet:i,all:n,isIn:r,set_difference:s,map_difference:o,map_intersect:l,map_merge:function(t,e={}){let{copy:i=!1,order:n=!1}=e;if(t instanceof Map)return t;if(!Array.isArray(t))throw new Error("illegal input array_of_maps",t);if(0==t.length)throw new Error("empty array_of_maps");if(!t.map(t=>t instanceof Map).every(t=>1==t))throw new Error("some object in array_of_maps is not a Map",t);n||t.sort((t,e)=>e.size-t.size);let r=i?new Map:t.shift();for(let e of t)for(let[t,i]of e.entries())r.set(t,i);return r},divmod:function(t,e){let i=t%e;return[(t-i)/e,i]},isIterable:a,array_concat:h,object_equals:c,docready:u});const d=function(t){let e=parseFloat(t);return t===e&&!isNaN(e)};function p(t,e,i,n){if(t==1/0&&(0==e||0==i))throw new Error("Infinity endpoint must be right-closed or singular");if(t==-1/0&&(1==e||0==i))throw new Error("-Infinity endpoint must be left-closed or singular");return[t,e,i,n]}function f(t){let[e,i,n,r]=t;return r||null==i?2:i?n?3:0:n?1:4}function v(t,e){if(void 0===t.length){if(!d(t))throw new Error("e1 not a number",t);t=p(t,void 0,void 0,!0)}if(void 0===e.length){if(!d(e))throw new Error("e2 not a number",e);e=p(e,void 0,void 0,!0)}return t[0]!=e[0]?[t[0],e[0]]:[f(t),f(e)]}function g(t,e){let[i,n]=v(t,e),r=i-n;return 0==r?0:r>0?1:-1}var m={cmp:g,toString:function(t){if(void 0===t.length)return t.toString();{let e=f(t),i=t[0];if(i!=1/0&&i!=-1/0||(i="--"),0==e)return i+")";if(1==e)return"["+i;if(2==e)return`[${i}]`;if(3==e)return i+"]";if(4==e)return"("+i}},equals:function(t,e){let[i,n]=v(t,e);return i==n},rightof:function(t,e){let[i,n]=v(t,e);return i>n},leftof:function(t,e){let[i,n]=v(t,e);return i<n},create:p,min:function(t,e){return g(t,e)<=0?t:e},max:function(t,e){return g(t,e)<=0?e:t}};const y=function(t){let e=parseFloat(t);return t===e&&!isNaN(e)};class w extends Error{constructor(t){super(t),this.name}}const k=Object.freeze({OUTSIDE_LEFT:64,OVERLAP_LEFT:32,COVERED:16,EQUALS:8,COVERS:4,OVERLAP_RIGHT:2,OUTSIDE_RIGHT:1}),E=k.OUTSIDE_LEFT+k.OUTSIDE_RIGHT,b=k.EQUALS+k.COVERED,I=b+k.OVERLAP_LEFT+k.OVERLAP_RIGHT,T=I+k.COVERS,O=T+E,S=Object.freeze({OUTSIDE:E,INSIDE:b,OVERLAP:I,COVERS:T,ALL:O});function M(t,e){if(!t instanceof A){if(!y(t))throw new w("a not interval",t);t=new A(t)}if(!e instanceof A){if(!y(e))throw new w("b not interval",e);e=new A(e)}let i=10*m.cmp(t.endpointLow,e.endpointLow)+m.cmp(t.endpointHigh,e.endpointHigh);return 11==i?m.leftof(e.endpointHigh,t.endpointLow)?k.OUTSIDE_RIGHT:k.OVERLAP_RIGHT:[-1,9,10].includes(i)?k.COVERED:[1,-9,-10].includes(i)?k.COVERS:0==i?k.EQUALS:m.rightof(e.endpointLow,t.endpointHigh)?k.OUTSIDE_LEFT:k.OVERLAP_LEFT}function R(t){return function(e,i){let n,r;return t?(n=[e.low,!1,e.lowInclude,e.singular],r=[i.low,!1,i.lowInclude,e.singular]):(n=[e.high,!0,e.highInclude,e.singular],r=[i.high,!0,i.highInclude,e.singular]),m.cmp(n,r)}}class A{constructor(t,e,i,n){if(y(t)&&void 0===e&&(e=t),!y(t))throw new w("low not a number");if(!y(e))throw new w("high not a number");if(t>e)throw new w("low > high");if(t===e&&(i=!0,n=!0),t===-1/0&&(i=!0),e===1/0&&(n=!0),void 0===i&&(i=!0),void 0===n&&(n=!1),"boolean"!=typeof i)throw new w("lowInclude not boolean");if("boolean"!=typeof n)throw new w("highInclude not boolean");this._low=t,this._high=e,this._lowInclude=i,this._highInclude=n,this._length=this._high-this._low,this._singular=this._low===this._high,this._finite=isFinite(this._low)&&isFinite(this._high),this._endpointLow=m.create(this._low,!1,this._lowInclude,this._singular),this._endpointHigh=m.create(this._high,!0,this._highInclude,this._singular)}get low(){return this._low}get high(){return this._high}get lowInclude(){return this._lowInclude}get highInclude(){return this._highInclude}get length(){return this._length}get singular(){return this._singular}get finite(){return this._finite}get endpointLow(){return this._endpointLow}get endpointHigh(){return this._endpointHigh}toString(){if(this._singular){return`[${this._endpointLow[0]}]`}return`${m.toString(this._endpointLow)},${m.toString(this._endpointHigh)}`}asArray(){return[this._low,this._high,this._lowInclude,this._highInclude]}covers_endpoint(t){let e=m.leftof(t,this._endpointLow),i=m.rightof(t,this._endpointHigh);return!e&&!i}compare(t){return M(this,t)}equals(t){return M(this,t)==k.EQUALS}match(t,e=T){let i=M(this,t);return Boolean(e&i)}}A.Relation=k,A.Match=S,A.cmpLow=R(!0),A.cmpHigh=R(!1),A.fromEndpoints=function(t,e){let[i,n,r,s]=t,[o,l,a,h]=e;if(n)throw new w("illegal endpointLow - bracket must be left");if(!l)throw new w("illegal endpointHigh - bracket must be right");return new A(i,o,r,a)},A.intersect=function(t,e){let i=M(t,e);return i==k.OUTSIDE_LEFT?[]:i==k.OVERLAP_LEFT?[A.fromEndpoints(e.endpointLow,t.endpointHigh)]:i==k.COVERS?[e]:i==k.EQUALS||i==k.COVERED?[t]:i==k.OVERLAP_RIGHT?[A.fromEndpoints(t.endpointLow,e.endpointHigh)]:i==k.OUTSIDE_RIGHT?[]:void 0},A.union=function(t,e){let i=M(t,e);return i==k.OUTSIDE_LEFT?t.high!=e.low||!t.highInclude&&!e.lowInclude?[t,e]:[A.fromEndpoints(t.endpointLow,e.endpointHigh)]:i==k.OVERLAP_LEFT?[A.fromEndpoints(t.endpointLow,e.endpointHigh)]:i==k.COVERS||i==k.EQUALS?[t]:i==k.COVERED?[e]:i==k.OVERLAP_RIGHT?[A.fromEndpoints(e.endpointLow,t.endpointHigh)]:i==k.OUTSIDE_RIGHT?e.high!=t.low||!e.highInclude&&!t.lowInclude?[e,t]:[A.fromEndpoints(e.endpointLow,t.endpointHigh)]:void 0},A.intersectAll=function(t){if(t.sort(A.cmpLow),t.length<=1)return t;const e=[t.shift()];for(;t.length>0;){let i=e.pop(),n=t.shift();e.push(...A.intersect(i,n))}return e},A.unionAll=function(t){if(t.sort(A.cmpLow),t.length<=1)return t;const e=[t.shift()];for(;t.length>0;){let i=e.pop(),n=t.shift();e.push(...A.union(i,n))}return e},function(){function t(t,e,i){return void 0===i||0==+i?Math[t](e):(e=+e,i=+i,isNaN(e)||"number"!=typeof i||i%1!=0?NaN:(e=e.toString().split("e"),+((e=(e=Math[t](+(e[0]+"e"+(e[1]?+e[1]-i:-i)))).toString().split("e"))[0]+"e"+(e[1]?+e[1]+i:i))))}Math.round10||(Math.round10=function(e,i){return t("round",e,i)}),Math.floor10||(Math.floor10=function(e,i){return t("floor",e,i)}),Math.ceil10||(Math.ceil10=function(e,i){return t("ceil",e,i)})}();const L=function(t,e){return t-e};function D(t,e){let i=t.position==e.position,n=t.velocity==e.velocity,r=t.acceleration==e.acceleration,s=t.timestamp==e.timestamp;return i&&n&&r&&s}function C(t,e){if(void 0===e)throw new Error("no ts provided for calculateVector");const i=e-t.timestamp;return{position:t.position+t.velocity*i+.5*t.acceleration*i*i,velocity:t.velocity+t.acceleration*i,acceleration:t.acceleration,timestamp:e}}function N(t,e){let i;i=null==e?t:C(t,e);let n=L(i.velocity,0);return 0===n&&(n=L(t.acceleration,0)),n}function x(t){return 0!==t.velocity||0!==t.acceleration}const P=Object.freeze({INIT:"init",INSIDE:"inside",OUTSIDE_LOW:"outsidelow",OUTSIDE_HIGH:"outsidehigh"});function H(t,e){const{position:i,velocity:n,acceleration:r}=t;if(i>e[1])return P.OUTSIDE_HIGH;if(i<e[0])return P.OUTSIDE_LOW;if(i===e[1]){if(n>0)return P.OUTSIDE_HIGH;if(0===n&&r>0)return P.OUTSIDE_HIGH}else if(i===e[0]){if(n<0)return P.OUTSIDE_LOW;if(0==n&&r<0)return P.OUTSIDE_HIGH}return P.INSIDE}function V(t,e){return H(t,e)!=P.INSIDE}function z(t,e){const i=H(t,e);return i!==P.INSIDE&&(t.velocity=0,t.acceleration=0,i===P.OUTSIDE_HIGH?t.position=e[1]:t.position=e[0]),t}function U(t,e){let i=t.timestamp,n=G(t,e[0]),r=G(t,e[1]);return void 0!==n&&void 0!==r?n<r?[i+n,e[0]]:[i+r,e[1]]:void 0!==n?[i+n,e[0]]:void 0!==r?[i+r,e[1]]:[void 0,void 0]}function q(t,e,i,n){return Math.pow(e,2)-2*i*(t-n)>=0}function B(t,e,i,n){if(0===i&&0===e)return t!=n?[]:[0];if(0===i)return[(n-t)/e];if(!1===q(t,e,i,n))return[];if(0===e*e-2*i*(t-n))return[-e/i];const r=Math.sqrt(Math.pow(e,2)-2*i*(t-n)),s=(-e+r)/i,o=(-e-r)/i;return[Math.min(s,o),Math.max(s,o)]}function G(t,e){const{position:i,velocity:n,acceleration:r}=t,s=function(t,e,i,n){const r=B(t,e,i,n);return 0===r.length?[]:1==r.length?r[0]>0?[r[0]]:[]:2==r.length?r[1]<0?[]:r[0]>0?[r[0],r[1]]:r[1]>0?[r[1]]:[]:[]}(i,n,r,e);return 0===s.length?void 0:s[0]}function j(t,e){let i=G(t,e[0]),n=G(t,e[1]);return i==1/0&&(i=void 0),n==1/0&&(n=void 0),void 0!==i&&void 0!==n?i<n?[i,e[0]]:[n,e[1]]:void 0!==i?[i,e[0]]:void 0!==n?[n,e[1]]:[void 0,void 0]}function $(t,e){if(!x(e)||t.singular)return new A(e.position);let i,n,r=t.low,s=t.high,o=(t.lowInclude,t.highInclude,C(e,r)),l=o.position,a=o.velocity,h=o.acceleration,c=C(e,s).position;if(0!=h){let e=-a/h+r;if(t.covers_endpoint(e)){let t=-a*a/(2*h)+l;h>0?l<c?(i=t,n=c):(i=t,n=l):l<c?(i=l,n=t):(i=c,n=t)}}return l<c?(i=l,n=c):(i=c,n=l),i=Math.floor10(i,-1),n=Math.ceil10(n,-1),new A(i,n,!0,!0)}function F(t,e,i){let[n,r,s,o]=t;return i<0&&void 0!==r&&(r=!r),[e,r,s,o]}function X(t,e,i,n){if(t.singular)throw new Error("endpointEvents: timeInterval is singular");if(!x(i))throw new Error("endpointEvents: no motion");let r,s,o,l,a,h=i.position,c=i.velocity,u=i.acceleration,_=i.timestamp,d=[];n.forEach((function(n){e.covers_endpoint(n.endpoint)?(r=n.endpoint[0],q(h,c,u,r)?(o=B(h,c,u,r),o.forEach((function(e){s=_+e,a=N(i,s),l=F(n.endpoint,s,a),t.covers_endpoint(l)&&(n.tsEndpoint=l,n.direction=a,d.push(n))}))):console.log("fuck 2")):console.log("fuck 1")}));return d.sort((function(t,e){return m.cmp(t.tsEndpoint,e.tsEndpoint)})),d}const Q=Object.freeze({NOOP:0,CHANGE:1}),W=Object.freeze({NOOP:0,NOOP_MOVING:1,START:2,CHANGE:3,STOP:4});class Y{constructor(t,e){let i=e.timestamp,n=x(e);if(null==t||null==t.position)this._mc=n?[Q.CHANGE,W.START]:[Q.CHANGE,W.NOOP];else{let r,s=x(t),o=C(t,i),l=C(e,i),a=o.position!=l.position?Q.CHANGE:Q.NOOP;if(s&&n){let t=o.velocity!=l.velocity,e=o.acceleration!=l.acceleration;r=t||e?W.CHANGE:W.NOOP_MOVING}else!s&&n?r=W.START:s&&!n?r=W.STOP:s||n||(r=W.NOOP);this._mc=[a,r]}}get posDelta(){return this._mc[0]}get moveDelta(){return this._mc[1]}toString(){const t=Y.PosDelta,e=Y.MoveDelta;let i=this.posDelta==t.CHANGE?"jump, ":"";return this.moveDelta==e.START?i+="movement started":this.moveDelta==e.CHANGE?i+="movement changed":this.moveDelta==e.STOP?i+="movement stopped":this.moveDelta==e.NOOP_MOVING?i+="movement noop - moving":this.moveDelta==e.NOOP&&(i+="movement noop - not moving"),i}}Y.PosDelta=Q,Y.MoveDelta=W;var J=Object.freeze({__proto__:null,equalVectors:D,copyVector:function(t){return{position:t.position,velocity:t.velocity,acceleration:t.acceleration,timestamp:t.timestamp}},calculateVector:C,calculateDirection:N,isMoving:x,RangeState:P,correctRangeState:H,detectRangeViolation:V,checkRange:z,rangeIntersect:U,calculateDelta:j,posInterval_from_timeInterval:$,timeEndpoint_from_posEndpoint:F,endpointEvents:X,MotionDelta:Y});class K extends Error{constructor(t){super(t),this.name="BinarySearchError"}}function Z(t,e){return t-e}class tt{constructor(t){this.array=[],this.options=t||{}}binaryIndexOf(t){let e,i,n=0,r=this.array.length-1;for(;n<=r;)if(e=(n+r)/2|0,i=this.array[e],i<t)n=e+1;else{if(!(i>t))return e;r=e-1}return~r}isFound(t,e){return t>0||0==t&&this.array.length>0&&this.array[0]==e}indexOf(t){var e=this.binaryIndexOf(t);return this.isFound(e,t)?e:-1}indexOfElements(t){let e,i,n=[];for(let r=0;r<t.length;r++)e=t[r],i=this.indexOf(e),i>-1&&n.push(i);return n}has(t){return this.indexOf(t)>-1}get(t){return this.array[t]}_update_splice(t,e,i){if(this.array.length>0){let e=this.indexOfElements(t);e.sort((function(t,e){return t-e}));for(let t=e.length-1;t>-1;t--)this.array.splice(e[t],1)}let n,r,s=e.length;for(let t=0;t<s;t++)n=e[t],r=this.binaryIndexOf(n),this.isFound(r,n)||this.array.splice(Math.abs(r),0,n)}_update_sort(t,e,i){if(this.array.length>0&&t.length>0){let e=this.indexOfElements(t);for(let t=0;t<e.length;t++)this.array[e[t]]=void 0}if(this.array=this.array.concat(e),this.array.sort(Z),t.length>0){let t=this.array.indexOf(void 0);t>-1&&this.array.splice(t,this.array.length-t)}var n;this.array=(n=this.array,[...new Set(n)])}update(t,e,i){let n=t.length+e.length;if(0==n)return;let r=(s=this.array.length,o=n,0==s?"sort":o<=100?"splice":"sort");var s,o;"splice"==r?this._update_splice(t,e,i):"sort"==r&&this._update_sort(t,e,i)}getMinimum(){return this.array.length>0?this.array[0]:void 0}getMaximum=function(){return this.array.length>0?this.array[this.array.length-1]:void 0};ltIndexOf(t){var e=this.binaryIndexOf(t);return this.isFound(e,t)?e>0?e-1:-1:Math.abs(e)-1}leIndexOf(t){var e=this.binaryIndexOf(t);return this.isFound(e,t)||(e=Math.abs(e)-1)>=0?e:-1}gtIndexOf(t){var e=this.binaryIndexOf(t);if(this.isFound(e,t))return e<this.array.length-1?e+1:-1;{let t=Math.abs(e);return t<this.array.length?t:-1}}geIndexOf(t){var e=this.binaryIndexOf(t);return this.isFound(e,t)||(e=Math.abs(e))<this.array.length?e:-1}lookupIndexes(t){if(void 0===t&&(t=new A(-1/0,1/0,!0,!0)),t instanceof A==!1)throw new K("lookup requires Interval argument");if(t.singular){let e=this.indexOf(t.low);return e>-1?[e,e+1]:[void 0,void 0]}var e=-1,i=-1;return-1===(e=t.lowInclude?this.geIndexOf(t.low):this.gtIndexOf(t.low))||-1===(i=t.highInclude?this.leIndexOf(t.high):this.ltIndexOf(t.high))?[void 0,void 0]:[e,i+1]}lookup(t){let[e,i]=this.lookupIndexes(t);return null!=e?this.array.slice(e,i):[]}remove(t){let[e,i]=this.lookupIndexes(t);return null!=e?this.array.splice(e,i-e):[]}slice(t,e){return this.array.slice(t,e)}splice(t,e){return this.array.splice(t,e)}removeInSlice(t){if(0==t.length)return;const e=t[0],i=t[t.length-1];let[n,r]=this.lookupIndexes(new A(e,i,!0,!0)),s=n,o=n,l=0;for(;s<r;){let e=this.array[s],i=t[l];if(e<i?(this.array[o]=this.array[s],o++,s++):e==i?(s++,l++):l++,l==t.length)break}this.array.splice(o,s-o)}values(){return this.array.values()}clear(){this.array=[]}get length(){return this.array.length}}class et{constructor(t,e,i){i=i||{},this.publisher=t,this.name=e,this.init=void 0!==i.init&&i.init,this.subscriptions=[]}subscribe(t,e){if(!t||"function"!=typeof t)throw new Error("Callback not a function",t);const i=new it(this,t,e);if(this.subscriptions.push(i),this.init&&i.init){i.init_pending=!0;let t=this;Promise.resolve().then((function(){const e=t.publisher.eventifyInitEventArgs(t.name)||[];for(let n of e)t.trigger(n,[i],!0);i.init_pending=!1}))}return i}trigger(t,e,i){let n,r;for(const s of e)if(!s.terminated){n={src:this.publisher,name:this.name,sub:s,init:i},r=s.ctx||this.publisher;try{s.callback.call(r,t,n)}catch(t){console.log(`Error in ${this.name}: ${s.callback} ${t}`)}}}unsubscribe(t){let e=this.subscriptions.indexOf(t);e>-1&&(this.subscriptions.splice(e,1),t.terminate())}}class it{constructor(t,e,i){i=i||{},this.event=t,this.name=t.name,this.callback=e,this.init=void 0===i.init?this.event.init:i.init,this.init_pending=!1,this.terminated=!1,this.ctx=i.ctx}terminate(){this.terminated=!0,this.callback=void 0,this.event.unsubscribe(this)}}function nt(t){return t.__eventify_eventMap=new Map,t.__eventify_buffer=[],t}function rt(t){function e(t,e){const i=t.__eventify_eventMap.get(e);if(null==i)throw new Error("Event undefined",e);return i}t.eventifyDefine=function(t,e){if(this.__eventify_eventMap.has(t))throw new Error("Event already defined",t);this.__eventify_eventMap.set(t,new et(this,t,e))},t.eventifyTrigger=function(t,e){return this.eventifyTriggerAll([{name:t,eArg:e}])},t.eventifyTriggerAlike=function(t,e){return this.eventifyTriggerAll(e.map(e=>({name:t,eArg:e})))},t.eventifyTriggerAll=function(t){if(0==t.length)return;let i=t.map(t=>{let{name:i,eArg:n}=t,r=e(this,i),s=r.subscriptions.filter(t=>0==t.init_pending);return[r,n,s]},this);const n=i.length,r=this.__eventify_buffer,s=this.__eventify_buffer.length;this.__eventify_buffer.length=s+n;for(let t=0;t<n;t++)r[s+t]=i[t];if(0==s){let t=this;Promise.resolve().then((function(){for(let[e,i,n]of t.__eventify_buffer)e.trigger(i,n,!1);t.__eventify_buffer=[]}))}},t.eventifySubscriptions=function(t){return e(this,t).subscriptions},t.on=function(t,i,n){return e(this,t).subscribe(i,n)},t.off=function(t){return e(this,t.name).unsubscribe(t)}}class st{constructor(t){nt(this),this._value=t,this.eventifyDefine("change",{init:!0})}eventifyInitEventArgs(t){if("change"==t)return[this._value]}get value(){return this._value}set value(t){t!=this._value&&(this._value=t,this.eventifyTrigger("change",t))}}rt(st.prototype);var ot={eventifyPrototype:rt,eventifyInstance:nt,EventVariable:st,EventBoolean:class extends st{constructor(t){super(Boolean(t))}set value(t){super.value=Boolean(t)}get value(){return super.value}},makePromise:function(t,e){return e=e||function(t){return 1==t},new Promise((function(i,n){let r=t.on("change",(function(n){e(n)&&(i(n),t.off(r))}))}))}};class lt{constructor(t={}){this.options=t,ot.eventifyInstance(this),this.eventifyDefine("batch",{init:!0}),this.eventifyDefine("change",{init:!0}),this.eventifyDefine("remove",{init:!1})}get datasource(){throw new Error("not implemented")}sortOrder(t={}){let{order:e=this.options.order}=t;if("function"==typeof e)return e}sortValues(t,e={}){let i=this.sortOrder(e);if("function"==typeof i){return(Array.isArray(t)?t:[...t]).sort(i)}return t}sortItems(t){let e=this.sortOrder();"function"==typeof e&&t.sort((function(t,i){let n=t.new?t.new:t.old,r=i.new?i.new:i.old;return e(n,r)}))}eventifyInitEventArgs(t){if("batch"==t||"change"==t){let e=[...this.datasource.entries()].map(([t,e])=>({key:t,new:e,old:void 0}));return this.sortItems(e),"batch"==t?[e]:e}}_notifyEvents(t){if(0==t.length)return;const e=this.eventifySubscriptions("batch").length>0,i=this.eventifySubscriptions("remove").length>0,n=this.eventifySubscriptions("change").length>0;if(e&&this.eventifyTrigger("batch",t),i||n)for(let e of t)null==e.new&&null!=e.old?i&&this.eventifyTrigger("remove",e):n&&this.eventifyTrigger("change",e)}get size(){return this.datasource.size}has(t){return this.datasource.has(t)}get(t){return this.datasource.get(t)}keys(){return this.datasource.keys()}values(){return this.datasource.values()}entries(){return this.datasource.entries()}set(t,e){let i=void 0;return this.datasource.has(t)&&(i=this.datasource.get(t)),this.datasource.set(t,e),this._notifyEvents([{key:t,new:e,old:i}]),this}delete(t){let e=!1,i=void 0;return this.datasource.has(t)&&(i=this.datasource.get(t),this.datasource.delete(t),e=!0),this._notifyEvents([{key:t,new:void 0,old:i}]),e}clear(){const t=[...this.datasource.entries()].map(([t,e])=>({key:t,new:void 0,old:e}));this.datasource.clear(),this._notifyEvents(t)}}ot.eventifyPrototype(lt.prototype);class at extends lt{static cmpLow(t,e){return A.cmpLow(t.interval,e.interval)}static cmpHigh(t,e){return A.cmpHigh(t.interval,e.interval)}sortOrder(t={}){let e=t.order||super.sortOrder(t);return"low"==e?at.cmpLow:"high"==e?at.cmpHigh:"function"==typeof e?e:void 0}cues(t={}){let e=this.sortValues(this.values(),t);return Array.isArray(e)?e:[...e]}}class ht{constructor(t,e){this.tid=void 0,this.to=t,this.callback=e}isSet(){return null!=this.tid}setTimeout(t,e){if(null!=this.tid)throw new Error("at most on timeout");let i=this.to.clock.now(),n=1e3*Math.max(t-i,0);this.tid=setTimeout(this.onTimeout.bind(this),n,t,e)}onTimeout(t,e){if(null!=this.tid){this.tid=void 0;let i=this.to.clock.now();i<t?this.setTimeout(t,e):this.callback(i,e)}}clear(){null!=this.tid&&(clearTimeout(this.tid),this.tid=void 0)}}"performance"in window==0&&(window.performance={},window.performance.offset=(new Date).getTime()),"now"in window.performance==0&&(window.performance.now=function(){return(new Date).getTime()-window.performance.offset});const ct=function(){return performance.now()/1e3};function ut(t,e){void 0===e&&(e=ct());var i=e-t.timestamp;return{position:t.position+t.velocity*i,velocity:t.velocity,timestamp:e}}class _t{constructor(t){var e=ct();t=t||{},this._vector={position:e,velocity:1,timestamp:e},ot.eventifyInstance(this),this.eventifyDefine("change",{init:!1}),this.adjust(t)}adjust(t){t=t||{};var e=ct(),i=this.query(e);void 0===t.skew&&void 0===t.rate||(this._vector={position:void 0!==t.skew?e+t.skew:i.position,velocity:void 0!==t.rate?t.rate:i.velocity,timestamp:i.timestamp},this.eventifyTrigger("change"))}now(){return ut(this._vector,ct()).position}query(t){return ut(this._vector,t)}}ot.eventifyPrototype(_t.prototype);class dt{constructor(t,e){e=e||{},this._clock=new _t({skew:0}),this._range=[-1/0,1/0],this._vector,this._callback=t,e.timestamp=e.timestamp||this._clock.now(),this._process_update(e)}get clock(){return this._clock}get range(){return this._range}get vector(){return this._vector}isReady(){return!0}_process_update(t){let{position:e,velocity:i,acceleration:n,timestamp:r,range:s,...o}=t,l=0,a=0,h=0;if(null!=this._vector){let t=C(this._vector,r);t=z(t,this._range),l=t.position,a=t.velocity,h=t.acceleration}let c={position:null!=e?e:l,velocity:null!=i?i:a,acceleration:null!=n?n:h,timestamp:r};if(null!=s){let[t,e]=s;t<e&&(t==this._range[0]&&e==this._range[1]||(this._range=[t,e]))}return c=z(c,this._range),this._old_vector=this._vector,this._vector=c,{range:s,...c,...o}}update(t){return t=this._process_update(t),this._callback(t)}close(){this._callback=void 0}}class pt{constructor(t,e,i){!function(t){let e=["on","skew","vector","range","update"];for(let i of e)if(!(i in t))throw new Error(`TimingProvider ${t} missing property ${i}`)}(t),this._provider=t,this._callback=e,this._range,this._vector,this._ready=!1,this._provider_clock,this._clock,this._provider.on("vectorchange",this._onVectorChange.bind(this)),this._provider.on("skewchange",this._onSkewChange.bind(this)),null!=this._provider.skew&&this._onSkewChange(!0)}isReady(){return this._ready}get clock(){return this._clock}get range(){return this._range}get vector(){let t=this._vector.timestamp-this._provider.skew;return{position:this._vector.position,velocity:this._vector.velocity,acceleration:this._vector.acceleration,timestamp:t}}get provider(){return this._provider}_onSkewChange(t=!1){if(this._clock){this._provider_clock.adjust({skew:this._provider.skew});let t=this._provider_clock.now()-this._clock.now(),e=this._provider.skew-t;this._clock.adjust({skew:e})}else this._provider_clock=new _t({skew:this._provider.skew}),this._clock=new _t({skew:0})}_onVectorChange(){if(this._clock&&(this._ready||null==this._provider.vector||(this._ready=!0),this._ready)){this._range||(this._range=this._provider.range),this._vector=this._provider.vector;let t={range:this.range,...this.vector};this._callback&&this._callback(t)}}update(t){let e={position:t.position,velocity:t.velocity,acceleration:t.acceleration,timestamp:t.timestamp};e.timestamp=e.timestamp+this._provider.skew;this._provider.update(e);return!0}close(){this._callback=void 0}}class ft{constructor(t,e){null!=t&&null==e&&(t instanceof ft||function(t){let e=["on","skew","vector","range","update"];for(let i of e)if(!(i in t))return!1;return!0}(t)||(e=t,t=void 0,e.provider?t=e.provider:e.timingsrc&&(t=e.timingsrc))),e=e||{},this.__options=e,null==e.timeout&&(e.timeout=!0),this.__old_vector,this.__vector,this.__range=[-1/0,1/0],this.__timeout=new ht(this,this.__handleTimeout.bind(this)),this.__tid=void 0,this.__timingsrc,this.__sub,this.__update_events=new Map,this.__ready=new ot.EventBoolean,ot.eventifyInstance(this),this.eventifyDefine("timingsrc",{init:!0}),this.eventifyDefine("change",{init:!0}),this.eventifyDefine("rangechange",{init:!0}),this.eventifyDefine("timeupdate",{init:!0}),this.__set_timingsrc(t,e)}eventifyInitEventArgs(t){if(this.__ready.value){if("timingsrc"==t){return[{...this.__vector,range:this.__range,live:!1}]}if("timeupdate"==t)return[void 0];if("change"==t)return[this.__vector];if("rangechange"==t)return[this.__range]}}isReady(){return this.__ready.value}get ready(){return ot.makePromise(this.__ready)}get range(){return[this.__range[0],this.__range[1]]}get vector(){return{position:this.__vector.position,velocity:this.__vector.velocity,acceleration:this.__vector.acceleration,timestamp:this.__vector.timestamp}}get old_vector(){return this.__old_vector}get delta(){return new Y(this.__old_vector,this.__vector)}get clock(){return this.__timingsrc.clock}get version(){return 5}query(){if(0==this.__ready.value)throw new Error("query before timing object is ready");let t=C(this.__vector,this.clock.now());return this.__timeout.isSet()?((t.position<this.__range[0]||this.__range[1]<t.position)&&this.__process({...t}),C(this.__vector,this.clock.now())):t}get pos(){return this.query().position}get vel(){return this.query().velocity}get acc(){return this.query().acceleration}__update(t){return this.__timingsrc instanceof ft?this.__timingsrc.__update(t):this.__timingsrc.update(t)}update(t){let e=null!=t.range;if(e=e||null!=t.position,e=e||null!=t.velocity,e=e||null!=t.acceleration,!e)return Promise.resolve(t);t.tunnel=Math.floor(1e4*Math.random()),null==t.timestamp&&(t.timestamp=this.clock.now());let i=new ot.EventVariable;this.__update_events.set(t.tunnel,i);let n=ot.makePromise(i,t=>null!=t);return this.__update(t),n}__handleEvent(t){let{range:e,live:i=!0,...n}=t;null!=e&&(e=[e[0],e[1]]);let r={range:e,live:i,...n};if(r=this.onUpdateStart(r),null!=r)return this.__process(r)}__handleTimeout(t,e){this.__process({...e})}__process(t){let{range:e,position:i,velocity:n,acceleration:r,timestamp:s,live:o=!0,...l}=t,a=!1;if(null!=e){let[t,i]=e;t<i&&(t==this.__range[0]&&i==this.__range[1]||(this.__range=[t,i],e=[t,i],a=!0))}let h,c=null!=i;c||a||console.log("__process: WARNING - no vector change and no range change"),h=c?{position:i,velocity:n,acceleration:r,timestamp:s}:{...this.__vector};let u,_=C(h,this.clock.now());if(V(_,this.__range)&&(h=this.onRangeViolation(_),o=!0),c=c||!D(h,this.__vector),c&&(this.__old_vector=this.__vector,this.__vector=h),u=a&&c?{range:e,...h,live:o,...l}:a?{range:e,live:o,...l}:c?{...h,live:o,...l}:{live:o,...l},this.__ready.value=!0,this.__dispatchEvents(u,a,c),this.__options.timeout&&this.__renewTimeout(),null!=u.tunnel){let t=this.__update_events.get(u.tunnel);t&&(this.__update_events.delete(u.tunnel),delete u.tunnel,t.value=u)}for(let t of this.__update_events.values())t.value={};return this.onUpdateDone(u),u}__dispatchEvents(t,e,i){let{range:n,position:r,velocity:s,acceleration:o,timestamp:l}=t;if(this.eventifyTrigger("timingsrc",t),i){let t={position:r,velocity:s,acceleration:o,timestamp:l};this.eventifyTrigger("change",t)}e&&this.eventifyTrigger("rangechange",n),this.eventifyTrigger("timeupdate");let a=x(this.__vector);if(a&&void 0===this.__tid){let t=this;this.__tid=setInterval((function(){t.eventifyTrigger("timeupdate")}),200)}else a||void 0===this.__tid||(clearTimeout(this.__tid),this.__tid=void 0)}onRangeViolation(t){return z(t,this.__range)}onUpdateStart(t){return t}onUpdateDone(t){}__renewTimeout(t,e){this.__timeout.clear();let i=this.__calculateTimeoutVector(t,e);null!=i&&this.__timeout.setTimeout(i.timestamp,i)}__calculateTimeoutVector(t,e){t=t||this.__vector,e=e||this.__range;let i=this.clock.now(),n=C(t,i),[r,s]=j(n,e);if(null==r)return;let o=C(t,i+r);return o.position=s,o}__clear_timingsrc(){null!=this.__timingsrc&&(this.__timingsrc instanceof ft?(this.__timingsrc.off(this.__sub),this.__sub=void 0,this.__timingsrc=void 0):(this.__timingsrc.close(),this.__timingsrc=void 0))}__set_timingsrc(t,e){let i=this.__handleEvent.bind(this);if(t instanceof ft)this.__timingsrc=t,this.__sub=this.__timingsrc.on("timingsrc",i);else if(this.__timingsrc=null==t?new dt(i,e):new pt(t,i,e),this.__timingsrc.isReady()){i({range:this.__timingsrc.range,...this.__timingsrc.vector,live:!1})}}__get_timingsrc(){return this.__timingsrc}get timingsrc(){let t=this.__get_timingsrc();if(t instanceof ft)return t;if(!(t instanceof dt)){if(t instanceof pt)return t._provider;throw new Error("illegal timingsrc")}}set timingsrc(t){this.__clear_timingsrc(),this.__set_timingsrc(t)}}ot.eventifyPrototype(ft.prototype);function vt(t,e){let i=e[0],n=e[1]-e[0];return i+((t-i)%(r=n)+r)%r;var r}function gt(){var t=P.INIT,e=null;return{get:function(){return t},set:function(i,n){var r=!1,s=!1;return i===t&&n===e||(r=!0),i!==t&&(s=function(t,e){return(t!==P.OUTSIDE_HIGH||e!==P.OUTSIDE_LOW)&&((t!==P.OUTSIDE_LOW||e!==P.OUTSIDE_HIGH)&&t!==P.INIT)}(t,i)),n!==e&&(e=n),i!==t&&(t=i),{special:s,absolute:r}}}}class mt{constructor(t,e={}){this._to=t,this._tid;let{period:i,frequency:n}=e;this._period=200,null!=i?this._period=i:null!=n&&(this._period=1/n),ot.eventifyInstance(this),this.eventifyDefine("change",{init:!0}),this._sub=this._to.on("change",this._onChange.bind(this))}eventifyInitEventArgs(t){if("change"==t&&this._to.isReady())return[this._to.pos]}_onChange(){let t=this._to.query(),e=0!=t.velocity||0!=t.acceleration;e&&null==this._tid&&(this._tid=setInterval(function(){this._onSample()}.bind(this),this._period)),e||null==this._tid||(clearTimeout(this._tid),this._tid=void 0),this._onSample(t.position)}_onSample(t){t=null!=t?t:this._to.pos,this.eventifyTrigger("change",t)}clear(){this._tid&&(clearTimeout(this._tid),this._tid=void 0),this._to.off(this._sub)}}function yt(t,e,i){return function(t,e){return[Math.floor(t/e),function(t,e){return(t%e+e)%e}(t,e)]}(t-i,e)}function wt(t,e,i){let[n,r]=t;return i+n*e+r}ot.eventifyPrototype(mt.prototype);const kt=A.Relation;function Et(){return Date.now()}function bt(t){if(t instanceof A||null==t)return t;if(Array.isArray(t)){let[e,i,n,r]=t;return new A(e,i,n,r)}throw new Error("input not an Interval",t)}function It(t,e){if(1==t.length)return t[0].key==e.key&&t.shift(),0==t.length;if(0==t.length)return!0;{let i=t.findIndex((function(t){return t.key==e.key}));return i>-1&&t.splice(i,1),0==t.length}}const Tt=[0,10,100,1e3,1e4,1e5,1/0];var Ot=function(t){for(let e=0;e<Tt.length;e++)if(t<=Tt[e])return Tt[e]};const St=Object.freeze({NOOP:0,INSERT:1,REPLACE:2,DELETE:3});function Mt(t,e,i){let n,r,s,o=null!=t&&null!=t.interval,l=null!=e&&null!=e.interval;o||l?o?l?(s=t.interval.equals(e.interval),n=s?St.NOOP:St.REPLACE):n=St.DELETE:n=St.INSERT:n=St.NOOP;let a=null!=t&&null!=t.data,h=null!=e&&null!=e.data;return a||h?a?h?(s=i?i(t.data,e.data):c(t.data,e.data),r=s?St.NOOP:St.REPLACE):r=St.DELETE:r=St.INSERT:r=St.NOOP,{interval:n,data:r}}class Rt{constructor(t,e={}){this._ds=t;this._options=Object.assign({},{autosubmit:!0},e),this._cues,this._done,this.updateDone,this._reset()}_reset(){this._cues=[],this._done=new ot.EventBoolean,this.updateDone=ot.makePromise(this._done).then(()=>this._submit.bind(this)())}_push(t){let e=this._cues.length,i=0==e,n=t.length;this._cues.length+=n;for(let i=0;i<n;i++)this._cues[e++]=t[i];this._options.autosubmit&&i&&n>0&&(this._done.value=!0)}_submit(){let t=[];return this._cues.length>0&&(t=this._ds.update(this._cues,this._options)),this._reset(),t}addCue(t,e,i){let n={key:t};return n.interval=e,arguments.length>2&&(n.data=i),this._push([n]),this}removeCue(t){return this._push([{key:t}]),this}update(t){this._push(t)}clear(){return this._cues=[],this}submit(){if(this._options.autosubmit)throw new Error("manual submit while options.autosubmit is true");this._done.value=!0}}class At extends at{constructor(t){super(t),this._map=new Map,this._builder=new Rt(this),this._cueBuckets=new Map;for(let t=0;t<Tt.length;t++){let e=Tt[t];this._cueBuckets.set(e,new Lt(e))}this._update_callbacks=[]}get datasource(){return this._map}add_callback(t){let e={handler:t};return this._update_callbacks.push(e),e}del_callback(t){let e=this._update_callbacks.indexof(t);e>-1&&this._update_callbacks.splice(e,1)}_notify_callbacks(t,e){this._update_callbacks.forEach((function(i){i.handler(t,e)}))}set(t,e){throw new Error("not implemented")}delete(t){throw new Error("not implemented")}makeBuilder(t){return new Rt(this,t)}get builder(){return this._builder}addCue(t,e,i){return arguments.length>2?this._builder.addCue(t,e,i):this._builder.addCue(t,e),this}removeCue(t){return this._builder.removeCue(t),this}get updateDone(){return this._builder.updateDone}_addCue(t,e,i,n){return this.update({key:t,interval:e,data:i},n)}_removeCue(t,e){return this.update({key:t},e)}update(t,e={}){const i=new Map;let n,r,s,{debug:o=!1,equals:l}=e;a(t)||(t=[t]);const h={ts:Et(),author:e.author};for(let o of t){if(null==o||!o.hasOwnProperty("key")||null==o.key){if(null==o)throw new Error("cue is undefined");if(!o.hasOwnProperty("key"))throw new Error("cue missing key property",o);if(null==o.key)throw new Error("cue.key is undefined",o)}r=o.hasOwnProperty("interval"),s=o.hasOwnProperty("data"),r&&(o.interval=bt(o.interval)),n=this._map.get(o.key),null==n?(r||(o.interval=void 0),s||(o.data=void 0)):null!=n&&(r||s?s?r||(o.interval=n.interval):o.data=n.data:(o.interval=void 0,o.data=void 0)),this._update_cue(i,n,o,h,e)}if(this._call_buckets("flush"),i.size>0){let t={low:1/0,high:-1/0},e=[...i.values()].map(e=>(e.new&&e.new.interval&&(t.low=m.min(t.low,e.new.interval.endpointLow),t.high=m.max(t.high,e.new.interval.endpointHigh)),e.old&&e.old.interval&&(t.low=m.min(t.low,e.old.interval.endpointLow),t.high=m.max(t.high,e.old.interval.endpointHigh)),{key:e.key,new:e.new,old:e.old,info:e.info})),n=e.filter(t=>{let e=Mt(t.new,t.old,l);return e.interval!=St.NOOP||e.data!=St.NOOP});this._notifyEvents(n);let r=void 0;return t.low!=1/0&&(r=A.fromEndpoints(t.low,t.high)),this._notify_callbacks(i,r),o&&this.integrity(),e}return o&&this.integrity(),[]}_update_cue(t,e,i,n,r){let s,o,l,a,h,c,u,_,d,p,{chaining:f=!0,safe:v=!1,equals:g}=r;if(e===i)throw Error("illegal cue arg: same object as current cue");let m=Mt(e,i,g);if(m.interval==St.NOOP&&m.data==St.NOOP)return l={key:i.key,new:e,old:e,delta:m},void t.set(i.key,l);if(null==e)null==i.info&&(i.info={ts:n.ts,change_ts:n.ts,change_id:0}),s=void 0,o=v?Object.freeze(i):i,this._map.set(i.key,o);else if(null==i.interval&&null==i.data)s=e,o=void 0,this._map.delete(i.key);else if(null==i.info&&(i.info={ts:e.info.ts,change_ts:n.ts,change_id:e.info.change_id+1}),s=e,o={key:i.key,interval:i.interval,data:i.data,info:i.info},v&&(o=Object.freeze(o)),this._map.set(i.key,o),s.interval){let t=Ot(s.interval.length),e=this._cueBuckets.get(t);e.replace_endpoint(s.interval.low,o),s.singular||e.replace_endpoint(s.interval.high,o)}if(l={key:i.key,new:o,old:s,delta:m,info:n},f&&(a=t.get(i.key),null!=a&&(l.old=a.old,l.delta=Mt(o,l.old,g))),t.set(i.key,l),m.interval!=St.NOOP){if(m.interval==St.INSERT?(d=!1,p=!0,u=!0,_=!0):m.interval==St.DELETE?(d=!0,p=!1,u=!0,_=!0):m.interval==St.REPLACE&&(d=!0,p=!0,u=o.interval.low!=s.interval.low,_=o.interval.high!=s.interval.high),d){let t=Ot(s.interval.length);h=this._cueBuckets.get(t)}if(p){let t=Ot(o.interval.length);c=this._cueBuckets.get(t)}h&&c&&h!=c&&(d=!0,p=!0,u=!0,_=!0),u&&(d&&h.del_endpoint(s.interval.low,s),p&&c.add_endpoint(o.interval.low,o)),_&&(d&&!s.interval.singular&&h.del_endpoint(s.interval.high,s),p&&!o.interval.singular&&c.add_endpoint(o.interval.high,o))}}_call_buckets(t,...e){const i=[];for(let n of this._cueBuckets.values()){let r=n[t](...e);null!=r&&r.length>0&&i.push(r)}return h(i)}lookup_endpoints(t){return t=bt(t),this._call_buckets("lookup_endpoints",t)}lookup(t,e){return t=bt(t),this._call_buckets("lookup",t,e)}lookup_delete(t,e,i={}){t=bt(t);const n=this._call_buckets("lookup_delete",t,e),r=[],s={ts:Et(),author:i.author};let o;for(let t=0;t<n.length;t++)o=n[t],this._map.delete(o.key),r.push({key:o.key,new:void 0,old:o,info:s});return this._notifyEvents(r),r}clear(t={}){this._call_buckets("clear");let e=this._map;this._map=new Map;const i=[],n={ts:Et(),author:t.author};for(let t of e.values())i.push({key:t.key,new:void 0,old:t,info:n});return this._notifyEvents(i),i}integrity(){const t=this._call_buckets("integrity");let e=[],i=[];for(let n of t.values())e.push(n.cues),i.push(n.points);e=[].concat(...e),i=[].concat(...i),i=[...new Set(i)];let n=[...this._map.values()].filter(t=>null==t.interval),r=e.length,s=n.length,l=this._map.size,a=l-r-s;if(0!=a)throw console.log("count buckets",r),console.log("count no intervals",s),console.log("count map",l),console.log("count diff",a),new Error("inconsistent cue count");let h=new Map(e.map(t=>[t.key,t])),c=new Map([...this._map.entries()].filter(([t,e])=>null!=e.interval)),u=o(h,c);if(u.size>0)throw console.log("buckets missing cues:"),console.log([...u.keys()]),new Error("buckets missing cues: "+[...u.keys()]);if(u=o(c,h),u.size>0)throw new Error("buckets too many cues: "+[...u.keys()]);return{cues:e.length,points:i.length}}}At.Delta=St,At.cue_delta=Mt,At.cue_equals=function(t,e){let i=Mt(t,e);return i.interval==St.NOOP&&i.data==St.NOOP};class Lt{constructor(t){this._maxLength=t,this._pointMap=new Map,this._pointIndex=new tt,this._created=new Set,this._dirty=new Set}add_endpoint(t,e){let i=0==this._pointMap.size?void 0:this._pointMap.get(t);null==i?(this._pointMap.set(t,[e]),this._created.add(t)):i.push(e)}del_endpoint(t,e){let i=0==this._pointMap.size?void 0:this._pointMap.get(t);if(null!=i){It(i,e)&&this._dirty.add(t)}}replace_endpoint(t,e){let i=0==this._pointMap.size?void 0:this._pointMap.get(t);if(null!=i){(function(t,e){if(0==t.length)return!1;if(1==t.length){if(t[0].key==e.key)return t[0]=e,!0}else{let i=t.findIndex((function(t){return t.key==e.key}));if(i>-1)return t[i]=e,!0}return!1})(i,e)||console.log("WARNING: attempt to replace non-existent cue in pointMap")}}flush(){if(0==this._created.size&&0==this._dirty.size)return;let t=[],e=[];for(let t of this._created.values()){this._pointMap.get(t).length>0?e.push(t):this._pointMap.delete(t)}for(let e of this._dirty.values()){let i=this._pointMap.get(e);null!=i&&(0==i.length&&(t.push(e),this._pointMap.delete(e)))}this._pointIndex.update(t,e),this._created.clear(),this._dirty.clear()}lookup_endpoints(t){if(0==this._pointMap.size)return[];const e=new A(t.low,t.high,!0,!0),i=this._pointIndex.lookup(e),n=[],r=i.length;let s,o;for(let l=0;l<r;l++)s=i[l],this._pointMap.get(s).forEach((function(i){if(s==i.interval.low)o=i.interval.endpointLow;else{if(s!=i.interval.high)throw console.log("DS INDEX ERROR"),console.log("cuebucket:",this._maxLength),console.log("lookup endpoints in interval",e.toString()),console.log("POINT:",s),console.log("CUE:",i.interval.toString()),this.integrity(),new Error("fatal: point cue mismatch");o=i.interval.endpointHigh}t.covers_endpoint(o)&&n.push({endpoint:o,cue:i})}),this);return n}_lookup_cues(t){if(0==this._pointMap.size)return[];const e=new A(t.low,t.high,!0,!0),i=this._pointIndex.lookup(e),n=i.length,r=new Set,s=[];for(let t=0;t<n;t++)this._pointMap.get(i[t]).forEach((function(t){r.has(t.key)||(r.add(t.key),s.push(t))}));return s}lookup(t,e=A.Match.COVERS){if(0==this._pointMap.size)return[];let i=[];if((e&=A.Match.COVERS)==kt.EQUALS)return this._pointMap.get(t.low).filter((function(e){return e.interval.match(t,kt.EQUALS)}));let n=e&A.Match.OVERLAP;if(n&&(i=this._lookup_cues(t).filter((function(e){return e.interval.match(t,n)}))),t.length>this._maxLength)return i;if(e&kt.COVERS){let e=t.high-this._maxLength,n=t.low;[e,n]=[Math.min(e,n),Math.max(e,n)];let r=new A(e,n,!0,!0);this._lookup_cues(r).forEach((function(e){e.interval.match(t,kt.COVERS)&&i.push(e)}))}return i}lookup_delete(t,e){const i=this.lookup(t,e),n=[];let r,s,o;for(let t=0;t<i.length;t++){r=i[t],o=r.interval.singular?[r.interval.low]:[r.interval.low,r.interval.high];for(let t=0;t<o.length;t++){s=o[t],It(this._pointMap.get(s),r)&&(this._pointMap.delete(s),n.push(s))}}return n.sort((function(t,e){return t-e})),this._pointIndex.removeInSlice(n),i}clear(){this._pointMap.clear(),this._pointIndex=new tt,this._created.clear(),this._dirty.clear()}integrity(){const t=new Set([...this._pointIndex.values()]),e=new Set([...this._pointMap.keys()]);if(!i(t,e)){let i=s(t,e);if(i.size>0)throw new Error("pointMap missing points: "+[...i]);if(i=s(e,t),i.size>0)throw new Error("pointIndex missing points: "+[...i])}let n=[...this._pointIndex.values()];if(n.length!=t.size)throw new Error("pointIndex include duplicate points");for(let t=1;t<n.length;t++)if(n[t-1]>=n[t])throw new Error("pointIndex not ordered");for(let t of n){let e=this._pointMap.get(t);for(let i of e)if(t!=i.interval.low&&t!=i.interval.high)throw console.log("POINT:",t),console.log("CUE:",i.interval.toString()),new Error("pointMap: wrong cue")}for(let t of[...this._pointMap.values()])for(let e of t)for(let t of[e.interval.low,e.interval.high])if(!this._pointMap.has(t))throw new Error(`cue found with low or high point not in pointMap ${t} -> ${e.interval.toString()} `);let r=[];for(let t of this._pointMap.values())for(let e of t)r.push(e);let o=new Map;for(let t of r){let e=o.get(t.key);if(null==e)o.set(t.key,t);else if(t!==e)throw new Error("pointMap: different cue objects for same key")}let l=[...o.values()];for(let t of l.values())if(t.interval.length>this._maxLength)throw new Error(`cue in wrong cue bucket  ${this._maxLength}, ${t.interval.toString()}`);return[{maxLength:this._maxLength,points:[...this._pointMap.keys()],cues:l}]}}const Dt=$;function Ct(t,e){return m.cmp(t.tsEndpoint,e.tsEndpoint)}class Nt{constructor(t,e,i){this.to=e,this.timeout=new ht(e,this.run.bind(this)),this.vector,this.timeInterval,this.posInterval,this.dataset=t,this.queue=[],this.callbacks=[],(i=i||{}).lookahead=i.lookahead||5,this.options=i}add_callback(t){let e={handler:t};return this.callbacks.push(e),e}del_callback(t){let e=this.callbacks.indexof(t);e>-1&&this.callbacks.splice(e,1)}_notify_callbacks(...t){this.callbacks.forEach((function(e){e.handler(...t)}))}setVector(t){let e=t.timestamp;this.vector;null!=this.vector&&(this.timeout.clear(),this.timeInterval=void 0,this.posInterval=void 0,this.queue=[]),this.vector=t,x(this.vector)&&this.run(e)}push(t){t.forEach((function(t){this.timeInterval.covers_endpoint(t.tsEndpoint)&&this.queue.push(t)}),this),this.queue.sort(Ct)}pop(t){let e=[];this.queue.length;for(;this.queue.length>0&&this.queue[0].tsEndpoint[0]<=t;)e.push(this.queue.shift());return e}next(){return this.queue.length>0?this.queue[0].tsEndpoint[0]:void 0}advance(t){let e,i=this.options.lookahead,n=!1;return null==this.timeInterval?(e=t,n=!0):m.leftof(this.timeInterval.endpointHigh,t)&&(e=this.timeInterval.high,n=!0),n&&(this.timeInterval=new A(e,e+i,!0,!1),this.posInterval=Dt(this.timeInterval,this.vector),this.queue=[]),n}load(t,e){let i=X(this.timeInterval,this.posInterval,this.vector,t),n=U(this.vector,this.to.range)[0];return null==e&&(e=this.timeInterval.endpointLow),i.filter((function(t){if(n<=t.tsEndpoint[0])return!1;if(m.leftof(t.tsEndpoint,e))return!1;if(0!=this.vector.acceleration){let e=t.tsEndpoint[0];if(e>this.timeInterval.endpointLow[0]){let i=C(this.vector,e);if(i.position==t.endpoint[0]&&0==i.velocity)return!1}}return!0}),this)}run(t){let e=this.pop(t);if(this.advance(t)){let i=this.dataset.lookup_endpoints(this.posInterval),n=this.load(i);this.push(n);let r=this.pop(t);e.push(...r)}e.length>0&&this._notify_callbacks(t,e,this);let i=this.next()||this.timeInterval.high;this.timeout.setTimeout(Math.min(i,this.timeInterval.high))}}function xt(t){return t.interval==At.Delta.NOOP&&t.data==At.Delta.NOOP}const Pt=Object.freeze({ENTER:1,STAY:0,EXIT:-1,ENTER_EXIT:2}),Ht=new Map([["LRL",Pt.STAY],["LRR",Pt.EXIT],["LRS",Pt.EXIT],["LLL",Pt.STAY],["LLR",Pt.ENTER],["LLS",Pt.ENTER],["RRL",Pt.ENTER],["RRR",Pt.STAY],["RRS",Pt.ENTER],["RLL",Pt.EXIT],["RLR",Pt.STAY],["RLS",Pt.EXIT],["SRL",Pt.ENTER],["SRR",Pt.EXIT],["SRS",Pt.ENTER_EXIT],["SLL",Pt.EXIT],["SLR",Pt.ENTER],["SLS",Pt.ENTER_EXIT]]);function Vt(t,e){return A.cmpLow(t.interval,e.interval)}function zt(t,e){return-1*A.cmpHigh(t.interval,e.interval)}function Ut(t,e){return Vt(t.new?t.new:t.old,e.new?e.new:e.old)}function qt(t,e){return zt(t.new?t.new:t.old,e.new?e.new:e.old)}class Bt extends at{constructor(t,e){super(e),this._map=new Map,this._ds=t;let i=this._onDatasetCallback.bind(this);this._ds_cb=this._ds.add_callback(i)}get datasource(){return this._map}get dataset(){return this._ds}_movementDirection(){throw new Error("not implemented")}sortValues(t,e={}){if("function"==typeof this.sortOrder(e))return super.sortValues(t,e);{let e=Array.isArray(t)?t:[...t];return this._movementDirection()>=0?e.sort(Vt):e.sort(zt),e}}sortItems(t,e){let i=this.sortOrder();if("function"==typeof i)return super.sortItems(t);null==i&&(null==e&&(e=this._movementDirection()),e>=0?t.sort(Ut):t.sort(qt))}set(t,e){throw new Error("not implemented")}delete(t){throw new Error("not implemented")}clear(t){throw new Error("not implemented")}_onDatasetCallback(t,e){throw new Error("not implemented")}_items_from_dataset_events(t,e){const i=[],n=[],r=[],s=0==this._map.size;let o,l,a;for(let h of t.values())xt(h.delta)||(o=!s&&this._map.has(h.key),l=!1,null!=h.new&&h.new.interval.match(e)&&(l=!0),o&&!l?(a={key:h.key,new:void 0,old:h.old,info:h.info},r.push(a)):!o&&l?(a={key:h.key,new:h.new,old:void 0,info:h.info},i.push(a)):o&&l&&(a={key:h.key,new:h.new,old:h.old,info:h.info},n.push(a)));return[r,n,i]}_items_from_dataset_lookup(t,e){const i=new Map(this._ds.lookup(e).map((function(t){return[t.key,t]})));let n,r=[],s=[],a=0==this._map.size;if(!a){let e=l(this._map,i);if(e.size>0){let i,n;for(let s of t.values())i=e.get(s.key),null==i||xt(s.delta)||(n={key:s.key,new:s.new,old:s.old},r.push(n))}s=[...o(this._map,i).values()].map(t=>({key:t.key,new:void 0,old:t}))}n=a?i:o(i,this._map);let h=[...n.values()].map(t=>({key:t.key,new:t,old:void 0}));for(let e in[s,r,h])for(let i of e){let e=t.get(i.key);null!=e&&(i.info=e.info)}return[s,r,h]}get builder(){return this.dataset.builder}addCue(t,e,i){return this.dataset.addCue(t,e,i)}removeCue(t){return this.dataset.removeCue(t)}_addCue(t,e,i){return this.dataset._addCue(t,e,i)}_removeCue(t){return this.dataset._removeCue(t)}update(t,e){return this.dataset.update(t,e)}clear(){return this.dataset.clear()}hasCue(t){return this.dataset.has(t)}getCue(t){return this.dataset.get(t)}getCues(){return this.dataset.cues()}getActiveKeys(){return[...this.keys()]}getActiveCues(){return this.cues()}isActive(t){return this.has(t)}}Bt.Active=Pt,Bt.ActiveMap=Ht;const Gt=Y.PosDelta,jt=Y.MoveDelta,$t=Bt.Active,Ft=Bt.ActiveMap;class Xt extends Bt{constructor(t,e,i){super(t,i),this._to=e,this._sub=this._to.on("timingsrc",this._onTimingCallback.bind(this)),this._sched=new Nt(this._ds,e);let n=this._onScheduleCallback.bind(this);this._sched_cb=this._sched.add_callback(n)}_movementDirection(){const t=this._to.clock.now();return N(this._to.vector,t)}_onDatasetCallback(t,e){if(!this._to.isReady())return;if(null==e)return;const i=this._to.clock.now(),n=C(this._to.vector,i),r=new A(n.position);if(!r.match(e,A.Match.OUTSIDE)){let e=this._items_from_dataset_events.bind(this);5e3<t.size&&this._map.size<5e3&&(e=this._items_from_dataset_lookup.bind(this));const[i,s,o]=e(t,r);i.forEach(t=>{this._map.delete(t.key)}),s.forEach(t=>{this._map.set(t.key,t.new)}),o.forEach(t=>{this._map.set(t.key,t.new)});let l=N(n);this.sortItems(i,l),this.sortItems(s,l),this.sortItems(o,l);const a=h([i,s,o],{copy:!0,order:!0});this._notifyEvents(a)}this._sched.posInterval&&(this._sched.posInterval.match(e,A.Match.OUTSIDE)||this._sched.setVector(n))}_onTimingCallback(t){let e;e=t.live?t:C(t,this._to.clock.now());let i=new Y(this._to.old_vector,e);if(i.posDelta==Gt.CHANGE||i.moveDelta==jt.STOP){let t=e.position,i=e.position,n=new A(t,i,!0,!0),r=new Map(this._ds.lookup(n).map(t=>[t.key,t])),s=o(this._map,r),l=o(r,this._map);this._map=r;let a=[...s.values()].map(t=>({key:t.key,new:void 0,old:t})),c=[...l.values()].map(t=>({key:t.key,new:t,old:void 0})),u=N(e);this.sortItems(a,u),this.sortItems(c,u);const _=h([a,c],{copy:!0,order:!0});this._notifyEvents(_)}this._sched.setVector(e)}_onScheduleCallback=function(t,e,i){if(!this._to.isReady())return;const n=[];e.forEach((function(t){let e=t.cue,i=this._map.has(e.key),[r,s,o,l]=t.endpoint,a=t.direction>0?"R":"L",h=l?"S":s?"R":"L",c=Ft.get(`S${a}${h}`);c==$t.ENTER_EXIT?i?(n.push({key:e.key,new:void 0,old:e}),this._map.delete(e.key)):(n.push({key:e.key,new:e,old:void 0}),n.push({key:e.key,new:void 0,old:e})):c==$t.ENTER?i||(n.push({key:e.key,new:e,old:void 0}),this._map.set(e.key,e)):c==$t.EXIT&&i&&(n.push({key:e.key,new:void 0,old:e}),this._map.delete(e.key))}),this),this._notifyEvents(n)}}const Qt=Y.PosDelta,Wt=Y.MoveDelta,Yt=Bt.Active,Jt=Bt.ActiveMap;function Kt(t,e){let i=N(t)+N(e);return i>0?1:i<0?-1:0}class Zt extends Bt{constructor(t,e,i,n){super(t,n),this._toA=e,this._toA_ready=!1,this._toB=i,this._toB_ready=!1;let r=this._onTimingCallback.bind(this);this._subA=this._toA.on("timingsrc",r),this._subB=this._toB.on("timingsrc",r);let s=this._onScheduleCallback.bind(this);this._schedA=new Nt(this._ds,e),this._schedA_cb=this._schedA.add_callback(s),this._schedB=new Nt(this._ds,i),this._schedB_cb=this._schedB.add_callback(s)}_isReady(){return this._toA_ready&&this._toB_ready}_movementDirection(){const t=this._toA.clock.now();return Kt(C(this._toA.vector,t),C(this._toB.vector,t))}_onDatasetCallback(t,e){if(!this._isReady())return;if(null==e)return;const i=this._toA.clock.now(),n=C(this._toA.vector,i),r=C(this._toB.vector,i);let[s,o]=[n.position,r.position],[l,a]=s<=o?[s,o]:[o,s];const c=new A(l,a,!0,!0);if(!c.match(e,A.Match.OUTSIDE)){let e=this._items_from_dataset_events.bind(this);5e3<t.size&&this._map.size<5e3&&(e=this._items_from_dataset_lookup.bind(this));const[i,s,o]=e(t,c);i.forEach(t=>{this._map.delete(t.key)}),s.forEach(t=>{this._map.set(t.key,t.new)}),o.forEach(t=>{this._map.set(t.key,t.new)});let l=Kt(n,r);this.sortItems(i,l),this.sortItems(s,l),this.sortItems(o,l);const a=h([i,s,o],{copy:!0,order:!0});this._notifyEvents(a,l)}this._schedA.posInterval&&(this._schedA.posInterval.match(e,A.Match.OUTSIDE)||this._schedA.setVector(n)),this._schedB.posInterval&&(this._schedB.posInterval.match(e,A.Match.OUTSIDE)||this._schedB.setVector(r))}_onTimingCallback(t,e){let i=!1;if(!this._isReady()){if(e.src==this._toA?this._toA_ready=!0:this._toB_ready=!0,!this._isReady())return;i=!0}const n=e.src,r=n==this._toA?this._toB:this._toA;let s;s=t.live?n.vector:C(n.vector,n.clock.now()),console.log(n.vector),console.log(s);const l=new Y(n.old_vector,s);let a=s.timestamp,c=C(r.vector,a);if(l.posDelta==Qt.CHANGE||l.MoveDelta==Wt.STOP){let t=Math.min(s.position,c.position),e=Math.max(s.position,c.position),i=new A(t,e,!0,!0);console.log("jump",s.position,c.position),console.log("jump new interval",i.toString());let n=new Map(this._ds.lookup(i).map(t=>[t.key,t])),r=o(this._map,n),l=o(n,this._map);this._map=n;let a=[...r.values()].map(t=>({key:t.key,new:void 0,old:t})),u=[...l.values()].map(t=>({key:t.key,new:t,old:void 0})),_=Kt(s,c);this.sortItems(a,_),this.sortItems(u,_);const d=h([a,u],{copy:!0,order:!0});this._notifyEvents(d)}n==this._toA?this._schedA.setVector(s):n==this._toB&&this._schedB.setVector(s),i&&(r==this._toA?this._schedA.setVector(c):r==this._toB&&this._schedB.setVector(c))}_onScheduleCallback=function(t,e,i){if(!this._isReady())return;const n=i.to==this._toA?this._toB:this._toA,r=[];e.forEach((function(t){let[e,i,s,o]=t.endpoint,l=t.tsEndpoint[0],a=C(n.vector,l),h=a.position,c=e<h?"L":e==h?"S":"R",u=t.direction>0?"R":"L",_=o?"S":i?"R":"L",d=Jt.get(`${c}${u}${_}`),p=t.cue,f=this._map.has(p.key);if(d==Yt.ENTER_EXIT){if(x(a)){d=N(a)!=t.direction?Yt.ENTER:Yt.EXIT}else d=Yt.ENTER}d==Yt.STAY&&(d=Yt.ENTER),d==Yt.ENTER&&f||(d!=Yt.EXIT||f)&&(d==Yt.ENTER?(r.push({key:p.key,new:p,old:void 0}),this._map.set(p.key,p)):d==Yt.EXIT&&(r.push({key:p.key,new:void 0,old:p}),this._map.delete(p.key)))}),this),this._notifyEvents(r)}}class te{static position2percent(t,e){let[i,n]=e;return 100*(t-i)/(n-i)}static percent2position(t,e){let[i,n]=e;return t=Math.max(0,t),i+(n-i)*(t=Math.min(100,t))/100}constructor(t,e,i={}){this._to=t,this._sampler=i.sampler,this._progress_elem=e,this._lock=!1,this._options=i,this._range=i.range||this._to.range;let[n,r]=this._range;if(n==-1/0||r==1/0)throw new Error("illegal range",this._range);this._progress_elem.addEventListener("input",function(){this._lock_value=!0}.bind(this)),this._progress_elem.addEventListener("change",function(){this._lock_value=!1;let t=parseInt(this._progress_elem.value),e=te.percent2position(t,this._range);this._to.update({position:e})}.bind(this)),this._sampler&&this._sampler.on("change",this.refresh.bind(this))}refresh(){let t=this._to.pos;if(!this._lock_value){let e=te.position2percent(t,this._range);if(this._options.thumb){if(e<0||100<e)return void this._options.thumb.hide()}else e=e<0?0:e,e=100<e?100:e;this._progress_elem.value=""+e,this._options.thumb&&this._options.thumb.show()}}}function ee(){let t=[...arguments].filter(t=>t instanceof At),e=t.length>0?t[0]:new At,i=[...arguments].filter(t=>t instanceof ft),n=[...arguments].filter(t=>Object.getPrototypeOf(t)===Object.prototype),r=n.length>0?n[0]:{};if(0==i.length)throw new Error("no timingobject in arguments");return 1==i.length?new Xt(e,i[0],r):new Zt(e,i[0],i[1],r)}Xt.prototype.clone=function(){let t=[this.dataset];return t.push.apply(t,[...arguments]),ee(...t)},Zt.prototype.clone=function(){let t=[this.dataset];return t.push.apply(t,[...arguments]),ee(...t)};return t.BinarySearch=tt,t.CueCollection=at,t.Dataset=At,t.DatasetViewer=class{constructor(t,i){this.ds=t,this.elem=i,this.nonce=e(4),this.ds.on("change",this.onchange.bind(this)),this.ds.on("remove",this.onremove.bind(this))}cue2string(t){let e=t.interval?t.interval.toString():"undefined",i=JSON.stringify(t.data);return`${t.key}, ${e}, ${i}`}onchange(t){let e=`${this.nonce}-${t.key}`,i=this.elem.querySelector("#"+e);if(i)i.innerHTML=this.cue2string(t.new);else{let i=document.createElement("div");i.innerHTML=this.cue2string(t.new),i.setAttribute("id",e),this.elem.appendChild(i)}}onremove(t){let e=`${this.nonce}-${t.key}`,i=document.getElementById(e);i&&i.parentNode.removeChild(i)}},t.DelayConverter=class extends ft{constructor(t,e){if(e<0)throw new Error("negative delay not supported");if(0===e)throw new Error("zero delay makes delayconverter pointless");super(t),this._delay=e,this._buffer=[],this._timeout=new ht(this,this.__handleDelayed.bind(this)),this.eventifyDefine("delaychange",{init:!0})}eventifyInitEventArgs(t){return"delaychange"==t?[this._delay]:super.eventifyInitEventArgs(t)}onUpdateStart(t){this._buffer.push(t),this._timeout.isSet()||this.__handleDelayed()}__handleDelayed(){let t,e,i=this.clock.now();for(;this._buffer.length>0&&(e=this._buffer[0].timestamp+this._delay,!(i<e));)t=this._buffer.shift(),t.timestamp=e,this.__process(t);this._buffer.length>0&&(e=this._buffer[0].timestamp+this._delay,this._timeout.setTimeout(e))}update(t){throw new Error("update is not legal on delayed (non-live) timingobject")}get delay(){return this._delay}set delay(t){t!=this._delay&&(this._delay=t,this._timeout.clear(),this.__handleDelayed(),this.eventifyTrigger("delaychange",t))}},t.Interval=A,t.LoopConverter=class extends ft{constructor(t,e){if(super(t,{timeout:!0}),!Array.isArray(e)||2!=e.length)throw new Error("range must be array [low, high], "+e);this.__range=e}update(t){if(null!=t.range){let[e,i]=t.range;if(e>=i)throw new Error("illegal range",t.range);if(e!=this.__range[0]||i!=this.__range[1]){this.__range=[e,i];let t=this.__get_timingsrc().query();t.position=vt(t.position,this.__range),this.__vector=t;let n={range:this.__range,...this.__vector,live:!0};this.__dispatchEvents(n,!0,!0)}delete t.range}if(null!=t.position){let e=this.clock.now(),i=C(this.vector,e).position-t.position,n=C(this.__get_timingsrc().vector,e);t.position=n.position-i}return super.update(t)}onRangeViolation(t){return t.position=vt(t.position,this.__range),t}onUpdateStart(t){return null!=t.range&&(t.range=this.__range),null!=t.position&&(t.position=vt(t.position,this.__range)),t}},t.PositionCallback=class{constructor(t,e,i={}){this._to=t;let{stride:n=1,offset:r=0}=i;this._offset=r,this._stride=n,this._callback=e,this._timeout=new ht(this._to,this._handleTimeout.bind(this)),this._to.on("timingsrc",this._onChange.bind(this))}_onChange(t,e){let i=t.live?t.position:this._to.pos;this._renewTimeout(i)}_calculateTimeout(t,e){let i=this._to.query(),[n,r]=j(i,[t,e]);if(null==n)return;let[s,o]=this._to.range;return r<s||o<r?[void 0,void 0]:[i.timestamp+n,r]}_renewTimeout(t){this._timeout.clear();let[e,i,n]=function(t,e,i){let[n,r]=yt(t,e,i),s=[n+1,0],o=0==r?[n-1,0]:[n,0];return o=wt(o,e,i),s=wt(s,e,i),[0==r,o,s]}(t,this._stride,this._offset);e&&this._callback(t);let r=this._calculateTimeout(i,n);if(null==r)return;let s=r[0];this._timeout.setTimeout(s,r)}_handleTimeout(t,e){let i=e[1];this._renewTimeout(i)}},t.RangeConverter=class extends ft{constructor(t,e){super(t,{timeout:!0}),this.__state=gt(),this.__range=e}update(t){throw Error("Not Implemented!")}onUpdateStart(t){if(null!=t.range&&delete t.range,null!=t.position){let{position:e,velocity:i,acceleration:n,timestamp:r}=t,s={position:e,velocity:i,acceleration:n,timestamp:r};if(s=this.onVectorChange(s),null==s)return void this.__renewTimeout(this.__get_timingsrc().vector,this.__range);t.position=s.position,t.velocity=s.velocity,t.acceleration=s.acceleration,t.timestamp=s.timestamp}return t}onVectorChange(t){var e=H(t,this.__range),i=this.__state.set(e,this.__range);if(i.special)this.__state.get()===P.INSIDE||(t=z(t,this.__range));else if(this.__state.get()===P.INSIDE);else{if(!i.absolute)return;t=z(t,this.__range)}return t}},t.ScaleConverter=class extends ft{constructor(t,e){super(t),this._factor=e,this.eventifyDefine("scalechange",{init:!0})}eventifyInitEventArgs(t){return"scalechange"==t?[this._factor]:super.eventifyInitEventArgs(t)}onUpdateStart(t){return null!=t.range&&(t.range=[t.range[0]*this._factor,t.range[1]*this._factor]),null!=t.position&&(t.position*=this._factor),null!=t.velocity&&(t.velocity*=this._factor),null!=t.acceleration&&(t.acceleration*=this._factor),t}update(t){return null!=t.position&&(t.position/=this._factor),null!=t.velocity&&(t.velocity/=this._factor),null!=t.acceleration&&(t.acceleration/=this._factor),super.update(t)}get scale(){return this._factor}set scale(t){t!=this._factor&&(this._factor=t,this.__handleEvent({...this.__get_timingsrc().vector,range:this.__get_timingsrc().range}),this.eventifyTrigger("scalechange",t))}},t.Sequencer=ee,t.SkewConverter=class extends ft{constructor(t,e,i){super(t,i),this._skew=e,this.eventifyDefine("skewchange",{init:!0})}eventifyInitEventArgs(t){return"skewchange"==t?[this._skew]:super.eventifyInitEventArgs(t)}onUpdateStart(t){return null!=t.range&&(t.range[0]+=this._skew,t.range[1]+=this._skew),null!=t.position&&(t.position+=this._skew),t}update(t){if(null!=t.position&&(t.position-=this._skew),null!=t.range){let[e,i]=t.range;t.range=[e-this._skew,i-this._skew]}return super.update(t)}get skew(){return this._skew}set skew(t){t!=this._skew&&(this._skew=t,this.__handleEvent({...this.__get_timingsrc().vector,range:this.__get_timingsrc().range}),this.eventifyTrigger("skewchange",t))}},t.Subset=class extends at{constructor(t,e={}){super(e),this._key_filter=e.key_filter,this._data_filter=e.data_filter,this._interval=e.interval,this._data_convert=e.data_convert,this._size=0,this._callbacks=[],this._src_ds=t;let i=this._onDatasetCallback.bind(this);this._src_ds_cb=this._src_ds.add_callback(i)}get datasource(){return this._src_ds}get dataset(){return this._src_ds}get interval(){return this._interval}set interval(t){this._setInterval(t)}add_callback(t){let e={handler:t};return this._callbacks.push(e),e}del_callback(t){let e=this._callbacks.indexof(t);e>-1&&this._callbacks.splice(e,1)}_notify_callbacks(t,e){this._callbacks.forEach((function(i){i.handler(t,e)}))}_cue_keep(t){return null!=t&&(!(this._interval&&!this._interval.match(t.interval))&&(!(this._key_filter&&!this._key_filter(t.key))&&!(this._data_filter&&!this._data_filter(t.data))))}_cue_convert(t){return null!=t&&this._data_convert?{key:t.key,interval:t.interval,data:this._data_convert(t.data)}:t}_items_filter_convert(t){let e=[];for(let i of t){if(null==i.new&&null==i.old)continue;let t=this._cue_keep(i.old)?i.old:void 0,n=this._cue_keep(i.new)?i.new:void 0;null==t&&null==n||(t=this._cue_convert(t),n=this._cue_convert(n),e.push({key:i.key,new:n,old:t}))}return e}_check_interval(t){if(this._interval)if(t){let e=A.intersect(t,this._interval);if(0==e.length)return console.log(`warning - lookup interval ${t.toString()} outside the subset interval ${this._interval.toString()}`),[];t=e[0]}else t=this._interval;return t}lookup(t,e){let i,n=this._check_interval(t);return i=n?this.datasource.lookup(n,e):[...this.datasource.values()],i.filter(this._cue_keep,this).map(this._cue_convert,this)}lookup_endpoints(t){let e=this._check_interval(t);return this.datasource.lookup_endpoints(e).filter(t=>this._cue_keep(t.cue),this).map(t=>({endpoint:t.endpoint,cue:this._cue_convert(t.cue)}),this)}eventifyInitEventArgs(t){if("batch"==t||"change"==t){let e=this.lookup().map(t=>({key:t.key,new:t,old:void 0}));return this.sortItems(e),"batch"==t?[e]:e}}_onDatasetCallback(t,e){let i=[...t.values()];i=this._items_filter_convert(i);for(let t of i)null!=t.new&&null==t.old?this._size+=1:null==t.new&&null!=t.old&&(this._size-=1);super._notifyEvents(i);let n=new Map(i.map(t=>[t.key,t]));this._interval&&(e=A.intersect(this._inverval,e)),this._notify_callbacks(n,e)}_setInterval(t){if(!t instanceof A)throw new Error("must be interval",t.toString());if(!this._interval||!this._interval.equals(t)){let e=this.lookup();this._interval=t;let i=this.datasource.lookup(t);i=i.filter(this._cue_keep,this).map(this._cue_convert,this);let n=new Map([...e].map(t=>[t.key,t])),r=new Map([...i].map(t=>[t.key,t])),s=o(n,r),l=o(r,n),a=[...s.values()].map(t=>({key:t.key,new:void 0,old:t})),c=[...l.values()].map(t=>({key:t.key,new:t,old:void 0}));this._size-=a.length,this._size+=c.length;const u=h([a,c],{copy:!1,order:!0});this._notifyEvents(u)}}get size(){return this._size}has(t){return null!=this.get(t)}get(t){let e=super.get(t);if(null!=e&&this._cue_keep(e))return this._cue_convert(e)}keys(){return this.values().map(t=>t.key)}values(){return[...super.values()].filter(t=>this._cue_keep(t),this).map(t=>this._cue_convert(t),this)}entries(){return this.values().map(t=>[t.key,t])}update(t,e){throw new Error("not implemented")}set(t,e){throw new Error("not implemented")}delete(t){throw new Error("not implemented")}clear(t){throw new Error("not implemented")}},t.Timeout=ht,t.TimeshiftConverter=class extends ft{constructor(t,e){super(t),this._offset=e,this.eventifyDefine("offsetchange",{init:!0})}eventifyInitEventArgs(t){return"offsetchange"==t?[this._offset]:super.eventifyInitEventArgs(t)}onUpdateStart(t){if(null!=t.range&&(t.range=[-1/0,1/0]),null!=t.position){let e=t.timestamp,i=C(t,e+this._offset);t.position=i.position,t.velocity=i.velocity,t.acceleration=i.acceleration,t.timestamp=e}return t}get offset(){return this._offset}set offset(t){t!=this._offset&&(this._offset=t,this.__handleEvent({...this.__get_timingsrc().vector,range:this.__get_timingsrc().range}),this.eventifyTrigger("offsetchange",t))}},t.TimingObject=ft,t.TimingProgress=te,t.TimingSampler=mt,t.endpoint=m,t.eventify=ot,t.motionutils=J,t.utils=_,t.version="v3.0",t}({});
//# sourceMappingURL=timingsrc-min-v3.js.map
